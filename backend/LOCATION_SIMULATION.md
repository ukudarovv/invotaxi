# Имитация местоположения водителей

Этот документ описывает команды для имитации текущего местоположения водителей по районам.

## Доступные команды

### 1. `simulate_driver_locations` - Разовое обновление местоположения

Устанавливает случайные координаты для всех водителей в пределах их регионов.

**Использование:**
```bash
python manage.py simulate_driver_locations [опции]
```

**Опции:**
- `--radius RADIUS` - Радиус в метрах от центра региона для генерации координат (по умолчанию 2000м)
- `--online-only` - Обновлять местоположение только для онлайн водителей

**Примеры:**
```bash
# Обновить всех водителей
python manage.py simulate_driver_locations

# Обновить только онлайн водителей с радиусом 1500м
python manage.py simulate_driver_locations --radius 1500 --online-only
```

### 2. `simulate_driver_movement` - Непрерывная имитация движения

Непрерывно обновляет местоположение водителей небольшими шагами, имитируя реальное движение.

**Использование:**
```bash
python manage.py simulate_driver_movement [опции]
```

**Опции:**
- `--interval INTERVAL` - Интервал обновления в секундах (по умолчанию 5 секунд)
- `--step-size STEP_SIZE` - Размер шага движения в метрах (по умолчанию 50м)
- `--online-only` - Обновлять местоположение только для онлайн водителей
- `--duration DURATION` - Длительность работы в секундах (0 = бесконечно, по умолчанию)

**Примеры:**
```bash
# Запустить имитацию движения (обновление каждые 5 секунд, шаг 50м)
python manage.py simulate_driver_movement

# Обновление каждые 3 секунды, шаг 30м, только онлайн водители
python manage.py simulate_driver_movement --interval 3 --step-size 30 --online-only

# Запустить на 60 секунд
python manage.py simulate_driver_movement --duration 60
```

## Быстрый запуск

### Windows
```bash
START_LOCATION_SIMULATION.bat
```

### Linux/Mac
```bash
chmod +x START_LOCATION_SIMULATION.sh
./START_LOCATION_SIMULATION.sh
```

## Как это работает

### Разовое обновление (`simulate_driver_locations`)
1. Получает всех водителей (или только онлайн)
2. Для каждого водителя генерирует случайные координаты в пределах его региона
3. Использует радиус обслуживания региона, если он задан, иначе использует указанный радиус
4. Обновляет `current_lat`, `current_lon` и `last_location_update`

### Непрерывное движение (`simulate_driver_movement`)
1. Получает всех водителей (или только онлайн)
2. Для каждого водителя:
   - Если нет текущей позиции - генерирует начальную позицию в центре региона
   - Иначе перемещает водителя на небольшое расстояние в случайном направлении
   - Проверяет, что водитель не выходит за границы региона
   - Если водитель слишком далеко от центра - направляет его к центру
3. Обновляет позиции каждые N секунд (по умолчанию 5)
4. Продолжает работу до остановки (Ctrl+C) или до достижения заданной длительности

## Особенности

- Водители остаются в пределах своих регионов
- Используется радиус обслуживания региона, если он задан
- Координаты генерируются с учетом широты (корректный расчет долготы)
- При непрерывном движении водители не выходят за границы региона
- Обновления отправляются через WebSocket (через сигналы Django)

## Использование в разработке

Для тестирования и разработки рекомендуется:

1. **Разовое обновление** - для быстрой установки позиций:
   ```bash
   python manage.py simulate_driver_locations
   ```

2. **Непрерывное движение** - для имитации реального времени:
   ```bash
   python manage.py simulate_driver_movement --interval 5 --step-size 50
   ```

3. **Только онлайн водители** - для более реалистичной симуляции:
   ```bash
   python manage.py simulate_driver_movement --online-only
   ```

## Интеграция с WebSocket

Обновления местоположения автоматически отправляются через WebSocket в группу `dispatch_map` благодаря сигналам Django (`accounts/signals.py`). Это позволяет видеть движение водителей в реальном времени в интерфейсе диспетчера.

## Примечания

- Команды работают с существующими водителями в базе данных
- Водители без назначенного региона пропускаются
- Для корректной работы требуется, чтобы регионы имели координаты центра
- Рекомендуется использовать радиус обслуживания в регионах для более точной имитации
