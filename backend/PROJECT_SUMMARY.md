# –†–µ–∑—é–º–µ –ø—Ä–æ–µ–∫—Ç–∞ Backend

## –°—Ç–∞—Ç—É—Å: ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

–í—Å–µ –∑–∞–¥–∞—á–∏ –∏–∑ –ø–ª–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã.

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ‚úÖ Django 5.0.1 –ø—Ä–æ–µ–∫—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ production
- ‚úÖ ASGI –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è WebSocket
- ‚úÖ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### 2. –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ User (–∫–∞—Å—Ç–æ–º–Ω–∞—è –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- ‚úÖ Passenger (–ø–∞—Å—Å–∞–∂–∏—Ä—ã —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏)
- ‚úÖ Driver (–≤–æ–¥–∏—Ç–µ–ª–∏ —Å –ø–æ–∑–∏—Ü–∏—è–º–∏ –∏ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–æ–º)
- ‚úÖ Order (–∑–∞–∫–∞–∑—ã —Å –ø–æ–ª–Ω—ã–º –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º)
- ‚úÖ Region (—Ä–µ–≥–∏–æ–Ω—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è)
- ‚úÖ OTPCode (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ OTP –∫–æ–¥—ã)
- ‚úÖ OrderEvent (–∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞–∫–∞–∑–æ–≤)

### 3. API Endpoints

#### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (`/api/auth/`)
- ‚úÖ POST `/api/auth/phone-login/` - –∑–∞–ø—Ä–æ—Å OTP
- ‚úÖ POST `/api/auth/verify-otp/` - –ø—Ä–æ–≤–µ—Ä–∫–∞ OTP, –ø–æ–ª—É—á–µ–Ω–∏–µ JWT
- ‚úÖ POST `/api/auth/logout/` - –≤—ã—Ö–æ–¥

#### –ó–∞–∫–∞–∑—ã (`/api/orders/`)
- ‚úÖ GET `/api/orders/` - —Å–ø–∏—Å–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
- ‚úÖ POST `/api/orders/` - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
- ‚úÖ GET `/api/orders/{id}/` - –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
- ‚úÖ PATCH `/api/orders/{id}/status/` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
- ‚úÖ GET `/api/orders/passenger/{id}/` - –∑–∞–∫–∞–∑—ã –ø–∞—Å—Å–∞–∂–∏—Ä–∞
- ‚úÖ GET `/api/orders/driver/{id}/` - –∑–∞–∫–∞–∑—ã –≤–æ–¥–∏—Ç–µ–ª—è

#### –í–æ–¥–∏—Ç–µ–ª–∏ (`/api/drivers/`)
- ‚úÖ GET `/api/drivers/` - —Å–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π
- ‚úÖ GET `/api/drivers/{id}/` - –¥–µ—Ç–∞–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—è
- ‚úÖ PATCH `/api/drivers/{id}/location/` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
- ‚úÖ PATCH `/api/drivers/{id}/online-status/` - –æ–Ω–ª–∞–π–Ω/–æ—Ñ–ª–∞–π–Ω

#### –ü–∞—Å—Å–∞–∂–∏—Ä—ã (`/api/passengers/`)
- ‚úÖ GET `/api/passengers/{id}/` - –ø—Ä–æ—Ñ–∏–ª—å –ø–∞—Å—Å–∞–∂–∏—Ä–∞

#### –î–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏—è (`/api/dispatch/`)
- ‚úÖ POST `/api/dispatch/assign/{order_id}/` - –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
- ‚úÖ GET `/api/dispatch/candidates/{order_id}/` - –∫–∞–Ω–¥–∏–¥–∞—Ç—ã

#### –†–µ–≥–∏–æ–Ω—ã (`/api/regions/`)
- ‚úÖ GET `/api/regions/` - —Å–ø–∏—Å–æ–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤

### 4. WebSocket
- ‚úÖ `/ws/orders/{order_id}/` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
- ‚úÖ `/ws/drivers/{driver_id}/` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª—è
- ‚úÖ `/ws/passengers/{passenger_id}/` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –ø–∞—Å—Å–∞–∂–∏—Ä–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ Django signals

### 5. –°–µ—Ä–≤–∏—Å—ã
- ‚úÖ **DispatchEngine** - –∞–ª–≥–æ—Ä–∏—Ç–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤:
  - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ —Ä–µ–≥–∏–æ–Ω—É
  - Fairness –∞–ª–≥–æ—Ä–∏—Ç–º (–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏)
  - –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π
- ‚úÖ **Geo** - —Ä–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π (—Ñ–æ—Ä–º—É–ª–∞ Haversine)
- ‚úÖ **GeofenceService** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–æ–∑–æ–Ω
- ‚úÖ **OTPService** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è OTP
- ‚úÖ **OrderService** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∑–∞–∫–∞–∑–æ–≤

### 6. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- ‚úÖ Custom permissions (IsPassenger, IsDriver, IsOwnerOrAdmin)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –≤–æ –≤—Å–µ—Ö endpoints

### 7. –£—Ç–∏–ª–∏—Ç—ã
- ‚úÖ Management –∫–æ–º–∞–Ω–¥–∞ `load_mock_data` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ Django Admin –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
- ‚úÖ API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### 8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ `README.md` - –æ–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
- ‚úÖ `SETUP_BACKEND.md` - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- ‚úÖ `API_DOCUMENTATION.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
- ‚úÖ `CHANGELOG.md` - –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 9. –î–µ–ø–ª–æ–π
- ‚úÖ Dockerfile –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ docker-compose.yml —Å PostgreSQL –∏ Redis
- ‚úÖ .env.example –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backend/
‚îú‚îÄ‚îÄ invo_backend/          # –ì–ª–∞–≤–Ω—ã–π –ø—Ä–æ–µ–∫—Ç Django
‚îÇ   ‚îú‚îÄ‚îÄ settings.py       # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ urls.py           # –ì–ª–∞–≤–Ω—ã–µ URLs
‚îÇ   ‚îú‚îÄ‚îÄ asgi.py           # ASGI –¥–ª—è WebSocket
‚îÇ   ‚îî‚îÄ‚îÄ wsgi.py           # WSGI –¥–ª—è production
‚îú‚îÄ‚îÄ accounts/              # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ models.py         # User, Passenger, Driver, OTPCode
‚îÇ   ‚îú‚îÄ‚îÄ views.py          # API views
‚îÇ   ‚îú‚îÄ‚îÄ serializers.py    # DRF serializers
‚îÇ   ‚îú‚îÄ‚îÄ services.py       # OTP –∏ User —Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îî‚îÄ‚îÄ permissions.py    # Custom permissions
‚îú‚îÄ‚îÄ orders/                # –ó–∞–∫–∞–∑—ã
‚îÇ   ‚îú‚îÄ‚îÄ models.py         # Order, OrderEvent
‚îÇ   ‚îú‚îÄ‚îÄ views.py          # OrderViewSet
‚îÇ   ‚îú‚îÄ‚îÄ serializers.py    # Order serializers
‚îÇ   ‚îú‚îÄ‚îÄ services.py       # OrderService
‚îÇ   ‚îî‚îÄ‚îÄ signals.py        # WebSocket signals
‚îú‚îÄ‚îÄ dispatch/              # –î–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ services.py       # DispatchEngine
‚îÇ   ‚îî‚îÄ‚îÄ views.py          # DispatchViewSet
‚îú‚îÄ‚îÄ geo/                   # –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ services.py       # Geo, GeofenceService
‚îú‚îÄ‚îÄ regions/               # –†–µ–≥–∏–æ–Ω—ã
‚îÇ   ‚îú‚îÄ‚îÄ models.py         # Region
‚îÇ   ‚îî‚îÄ‚îÄ views.py          # RegionViewSet
‚îî‚îÄ‚îÄ websocket/             # WebSocket
    ‚îú‚îÄ‚îÄ consumers.py      # WebSocket consumers
    ‚îî‚îÄ‚îÄ routing.py        # WebSocket routing
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫:**
   ```bash
   cd backend
   pip install -r requirements.txt
   python manage.py migrate
   python manage.py load_mock_data
   python manage.py runserver
   ```

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Postman –∏–ª–∏ curl
   - –°–º. –ø—Ä–∏–º–µ—Ä—ã –≤ `API_DOCUMENTATION.md`

3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Flutter:**
   - –ó–∞–º–µ–Ω–∏—Ç–µ MockDB –Ω–∞ HTTP –∫–ª–∏–µ–Ω—Ç
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   - –û–±–Ω–æ–≤–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

4. **Production:**
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ PostgreSQL
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Redis –¥–ª—è WebSocket
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ SMS –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è OTP
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Nginx –∏ SSL

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Django 5.0.1** - –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **Django REST Framework** - REST API
- **Django Channels** - WebSocket –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- **JWT** - –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- **SQLite** - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (dev)
- **PostgreSQL** - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (production)

## –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ

