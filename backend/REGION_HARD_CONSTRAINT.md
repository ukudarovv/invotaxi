# Операционный регламент: Регион как жесткое условие

## Обзор

В системе введено правило: **каждый водитель работает только в своем районе**. Район является жестким условием (hard constraint) при распределении заказов, а не фактором приоритета.

## Определение района заказа

### Автоматическое определение

Район заказа определяется автоматически по координатам точки **pickup** (отправления):

1. Используется функция `regions.services.get_region_by_coordinates(lat, lon)`
2. Проверка через полигон (`polygon_coordinates`) - алгоритм point-in-polygon
3. Если полигона нет → проверка через радиус обслуживания (`service_radius_meters`)
4. Если район не определен → используется fallback на район пассажира (`order.passenger.region`)

### Fallback

Если район невозможно определить по координатам pickup:
- Используется район пассажира
- Логируется предупреждение
- Заказ все равно может участвовать в матчинге

## Правила заполнения данных

### Для водителей

**ОБЯЗАТЕЛЬНО:** У каждого водителя должен быть заполнен `region`

- Проверка: `python manage.py validate_driver_regions`
- Исправление: `python manage.py validate_driver_regions --fix`
- Онлайн водители без региона **не участвуют в матчинге**

### Для заказов

При создании заказа:
- Автоматически определяется `pickup_region` по координатам
- Если не определен → используется `passenger.region`

Проверка: `python manage.py validate_order_regions`

## Алгоритм распределения

### DispatchEngine (базовый алгоритм)

1. **Фильтрация по району** (`_find_candidates`)
   - Жесткий фильтр: `driver.region == order.pickup_region`
   - Водители без региона исключаются
   - Если кандидатов нет → ошибка "Нет водителей в районе X"

2. **Приоритет** (`_calculate_priority`)
   - Учитывается только fairness и расстояние
   - Район уже отфильтрован, не учитывается в приоритете

### MatchingService (продвинутый алгоритм)

1. **Фильтрация по району** (`_filter_candidates`)
   - Жесткий фильтр в QuerySet: `Q(region=order.pickup_region)`
   - Дополнительная проверка: водители без региона исключаются

2. **Расширение поиска** (`_expand_search`)
   - Увеличивается только ETA/радиус
   - **НЕ расширяет на другие районы**
   - Поиск продолжается только в том же районе

## Мониторинг и диагностика

### Логирование

В логах отображается:
- Район заказа перед фильтрацией
- Количество кандидатов до фильтрации по району
- Количество кандидатов после фильтрации по району
- Количество отфильтрованных по району водителей

### Команды проверки

1. **Проверка водителей:**
   ```bash
   python manage.py validate_driver_regions
   python manage.py validate_driver_regions --online-only  # только онлайн
   python manage.py validate_driver_regions --fix  # интерактивное исправление
   ```

2. **Проверка заказов:**
   ```bash
   python manage.py validate_order_regions
   python manage.py validate_order_regions --status created,matching,active_queue
   ```

### Нормальные ситуации

- **"Нет водителей в районе X"** - нормально, если в районе действительно нет свободных водителей
- Заказы с fallback на район пассажира - нормально, если координаты не попадают в границы районов

### Требующие внимания

- Водители онлайн без региона - требуют срочного исправления
- Заказы без возможности определить район (нет ни pickup_region, ни passenger.region) - требуют ручной обработки диспетчером

## Действия диспетчера

### Назначение региона водителю

1. В админке Django: `Accounts → Drivers → [Водитель] → Region`
2. Через команду: `python manage.py validate_driver_regions --fix`
3. Массово через Excel импорт: `python manage.py import_drivers_from_excel`

### Обработка заказов без района

Если заказ не может определить район автоматически:
1. Проверить координаты pickup
2. При необходимости обновить координаты заказа
3. Если координаты корректны, но район не определен - назначить водителя вручную

## Импорт данных

### Импорт заказов из Excel

```bash
python manage.py import_orders_from_excel data/data.xlsx
python manage.py import_orders_from_excel data/data.xlsx --dry-run  # только валидация
python manage.py import_orders_from_excel data/data.xlsx --skip-errors  # пропускать ошибки
```

**Обязательные поля в Excel:**
- `passenger_id` или `passenger_phone`
- `pickup_title`, `pickup_lat`, `pickup_lon`
- `dropoff_title`, `dropoff_lat`, `dropoff_lon`
- `desired_pickup_time`

### Импорт водителей из Excel

```bash
python manage.py import_drivers_from_excel "data/водитель (1).xlsx"
python manage.py import_drivers_from_excel "data/водитель (1).xlsx --dry-run
```

**Обязательные поля в Excel:**
- `name`, `phone`
- `region_id` или `region_title`
- `car_model`, `plate_number`
- `capacity`

## Чеклист готовности

- [ ] Все водители имеют заполненный `region`
- [ ] Функция определения региона работает корректно
- [ ] Логи показывают фильтрацию по району
- [ ] Заказы без определенного региона обрабатываются через fallback
- [ ] Расширение поиска не выходит за границы района
- [ ] Импорт заказов из Excel работает
- [ ] Импорт водителей из Excel работает
- [ ] UI импорта/экспорта заказов работает
