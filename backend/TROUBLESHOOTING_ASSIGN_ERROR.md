# Диагностика ошибки 400 при назначении водителя

## Описание проблемы

При попытке назначить водителя на заказ через endpoint `/api/dispatch/assign/{order_id}/` возникает ошибка 400 Bad Request.

## Возможные причины

### 1. Заказ не в статусе `active_queue`

**Симптомы:**
- Заказ находится в статусе, который нельзя перевести в `active_queue`
- Endpoint пытается автоматически перевести заказ, но переход недопустим

**Решение:**
Проверьте текущий статус заказа и переведите его в один из допустимых статусов:
- `submitted`
- `awaiting_dispatcher_decision`
- `matching`
- `cancelled` (можно восстановить)

**Допустимые переходы в `active_queue`:**
- Из `submitted` → `active_queue` (через `matching`)
- Из `awaiting_dispatcher_decision` → `active_queue`
- Из `matching` → `active_queue`
- Из `cancelled` → `active_queue`
- Из `assigned` → `matching` → `active_queue`

### 2. Водитель не найден

**Симптомы:**
- Водитель с указанным ID не существует в базе данных

**Решение:**
Проверьте, что водитель существует:
```bash
GET /api/drivers/{driver_id}/
```

### 3. Водитель не онлайн

**Симптомы:**
- Водитель существует, но `is_online = false`

**Решение:**
Водитель должен включить онлайн статус перед назначением:
```bash
PATCH /api/drivers/{driver_id}/online-status/
{
  "is_online": true
}
```

### 4. Водитель занят

**Симптомы:**
- Водитель имеет статус `on_trip`, `enroute_to_pickup` или `offered`

**Решение:**
Дождитесь завершения текущего заказа или выберите другого водителя.

### 5. Недостаточная вместимость

**Симптомы:**
- Вместимость автомобиля водителя меньше требуемого количества мест

**Решение:**
Выберите водителя с достаточной вместимостью или измените параметры заказа (уберите сопровождение).

## Улучшенная обработка ошибок

После обновления кода, при ошибке 400 вы получите детальную информацию:

```json
{
  "success": false,
  "error": "Водитель не онлайн. Включите онлайн статус для назначения заказов.",
  "driver_id": 1,
  "driver_name": "Иванов Иван",
  "is_online": false
}
```

Или для ошибки статуса:

```json
{
  "success": false,
  "error": "Заказ должен быть в статусе active_queue для назначения. Текущий статус: assigned",
  "current_status": "assigned",
  "valid_transitions": ["driver_en_route", "matching", "cancelled"],
  "suggestion": "Сначала переведите заказ в один из допустимых статусов",
  "order_id": "order_1768238070872"
}
```

## Как диагностировать

1. **Проверьте логи Django сервера:**
   ```
   Назначение заказа {order_id}: текущий статус = {status}, driver_id = {driver_id}
   ```

2. **Проверьте текущий статус заказа:**
   ```bash
   GET /api/orders/order_1768238070872/
   ```

3. **Проверьте статус водителя:**
   ```bash
   GET /api/drivers/{driver_id}/
   ```

4. **Проверьте консоль браузера:**
   - Там будут детальные логи ошибки
   - Информация о текущем статусе и допустимых переходах

## Примеры правильных запросов

### Назначение водителя на заказ в очереди:
```bash
POST /api/dispatch/assign/order_1768238070872/
Authorization: Bearer <token>
Content-Type: application/json

{
  "driver_id": 1
}
```

### Перед назначением перевести заказ в очередь:
```bash
# Шаг 1: Перевести в очередь
PATCH /api/orders/order_1768238070872/status/
{
  "status": "active_queue",
  "reason": "Перевод в очередь для назначения"
}

# Шаг 2: Назначить водителя
POST /api/dispatch/assign/order_1768238070872/
{
  "driver_id": 1
}
```

## Автоматическая обработка

Endpoint назначения автоматически пытается перевести заказ в `active_queue` если:
- Заказ в статусе `submitted`, `awaiting_dispatcher_decision`, `matching`, `cancelled`
- Заказ в статусе `assigned` (сначала переводит в `matching`, затем в `active_queue`)

Если автоматический перевод невозможен, вы получите детальное сообщение об ошибке с указанием допустимых переходов.
